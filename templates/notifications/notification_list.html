{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications - School Manager{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Notifications</h1>
        <p class="text-gray-600">Stay updated with school announcements and important information</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <button onclick="markAllAsRead()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-check-double mr-2"></i>
          Mark All Read
        </button>
        <button onclick="createNotification()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-plus mr-2"></i>
          New Notification
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Filter Tabs -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="border-b border-gray-200">
    <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
      <button onclick="filterNotifications('all')" class="filter-tab active py-4 px-1 border-b-2 border-primary-500 font-medium text-sm text-primary-600">
        All Notifications
        <span class="ml-2 bg-primary-100 text-primary-600 py-0.5 px-2.5 rounded-full text-xs">{{ notifications|length }}</span>
      </button>
      <button onclick="filterNotifications('unread')" class="filter-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
        Unread
        <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs" id="unreadCount">{{ unread_count }}</span>
      </button>
      <button onclick="filterNotifications('announcements')" class="filter-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
        Announcements
        <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs">{{ announcements_count }}</span>
      </button>
      <button onclick="filterNotifications('alerts')" class="filter-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
        Alerts
        <span class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs">{{ alerts_count }}</span>
      </button>
    </nav>
  </div>
</div>

<!-- Notifications List -->
<div class="space-y-4" id="notificationsList">
  {% for notification in notifications %}
  <div class="notification-item bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 {% if not notification.read %}border-l-4 border-l-primary-500{% endif %}" data-type="{{ notification.type }}" data-read="{{ notification.read|yesno:'true,false' }}">
    <div class="p-6">
      <div class="flex items-start space-x-4">
        <!-- Notification Icon -->
        <div class="flex-shrink-0">
          {% if notification.type == 'announcement' %}
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-bullhorn text-blue-600"></i>
            </div>
          {% elif notification.type == 'alert' %}
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
              <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
          {% elif notification.type == 'reminder' %}
            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
              <i class="fas fa-clock text-yellow-600"></i>
            </div>
          {% else %}
            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
              <i class="fas fa-bell text-gray-600"></i>
            </div>
          {% endif %}
        </div>

        <!-- Notification Content -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900 {% if not notification.read %}font-bold{% endif %}">
              {{ notification.title }}
            </h3>
            <div class="flex items-center space-x-2">
              {% if not notification.read %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                  New
                </span>
              {% endif %}
              <span class="text-sm text-gray-500">{{ notification.created|timesince }} ago</span>
            </div>
          </div>
          
          <p class="mt-1 text-sm text-gray-600">{{ notification.message|truncatechars:200 }}</p>
          
          <!-- Notification Actions -->
          <div class="mt-4 flex items-center space-x-4">
            <button onclick="markAsRead({{ notification.id }})" class="text-sm text-primary-600 hover:text-primary-500 font-medium">
              {% if notification.read %}
                <i class="fas fa-check mr-1"></i>Mark as Unread
              {% else %}
                <i class="fas fa-check mr-1"></i>Mark as Read
              {% endif %}
            </button>
            <button onclick="viewNotification({{ notification.id }})" class="text-sm text-gray-600 hover:text-gray-500 font-medium">
              <i class="fas fa-eye mr-1"></i>View Details
            </button>
            {% if user.is_staff %}
            <button onclick="editNotification({{ notification.id }})" class="text-sm text-gray-600 hover:text-gray-500 font-medium">
              <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button onclick="deleteNotification({{ notification.id }})" class="text-sm text-red-600 hover:text-red-500 font-medium">
              <i class="fas fa-trash mr-1"></i>Delete
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center py-12">
    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-bell text-gray-400 text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications</h3>
    <p class="text-gray-500">You're all caught up! Check back later for new updates.</p>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if notifications.has_other_pages %}
<div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-6 rounded-lg shadow-sm">
  <div class="flex-1 flex justify-between sm:hidden">
    {% if notifications.has_previous %}
      <a href="?page={{ notifications.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
        Previous
      </a>
    {% endif %}
    {% if notifications.has_next %}
      <a href="?page={{ notifications.next_page_number }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
        Next
      </a>
    {% endif %}
  </div>
  <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
    <div>
      <p class="text-sm text-gray-700">
        Showing
        <span class="font-medium">{{ notifications.start_index }}</span>
        to
        <span class="font-medium">{{ notifications.end_index }}</span>
        of
        <span class="font-medium">{{ notifications.paginator.count }}</span>
        results
      </p>
    </div>
    <div>
      <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        {% if notifications.has_previous %}
          <a href="?page={{ notifications.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
            <i class="fas fa-chevron-left"></i>
          </a>
        {% endif %}
        
        {% for num in notifications.paginator.page_range %}
          {% if notifications.number == num %}
            <span class="relative inline-flex items-center px-4 py-2 border border-primary-500 bg-primary-50 text-sm font-medium text-primary-600">
              {{ num }}
            </span>
          {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
            <a href="?page={{ num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}
        
        {% if notifications.has_next %}
          <a href="?page={{ notifications.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
      </nav>
    </div>
  </div>
</div>
{% endif %}

<!-- Create Notification Modal -->
<div id="createNotificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Create New Notification</h3>
        <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="createNotificationForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input type="text" id="notificationTitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Type</label>
          <select id="notificationType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
            <option value="general">General</option>
            <option value="announcement">Announcement</option>
            <option value="alert">Alert</option>
            <option value="reminder">Reminder</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Message</label>
          <textarea id="notificationMessage" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Recipients</label>
          <div class="mt-2 space-y-2">
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" value="all">
              <span class="ml-2 text-sm text-gray-700">All Users</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" value="students">
              <span class="ml-2 text-sm text-gray-700">Students</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" value="teachers">
              <span class="ml-2 text-sm text-gray-700">Teachers</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" value="parents">
              <span class="ml-2 text-sm text-gray-700">Parents</span>
            </label>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeCreateModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Create Notification
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
function filterNotifications(type) {
  // Remove active class from all tabs
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active', 'border-primary-500', 'text-primary-600');
    tab.classList.add('border-transparent', 'text-gray-500');
  });
  
  // Add active class to selected tab
  event.target.classList.add('active', 'border-primary-500', 'text-primary-600');
  event.target.classList.remove('border-transparent', 'text-gray-500');
  
  // Filter notifications
  const notifications = document.querySelectorAll('.notification-item');
  notifications.forEach(notification => {
    if (type === 'all') {
      notification.style.display = 'block';
    } else if (type === 'unread') {
      notification.style.display = notification.dataset.read === 'false' ? 'block' : 'none';
    } else {
      notification.style.display = notification.dataset.type === type ? 'block' : 'none';
    }
  });
}

function markAsRead(notificationId) {
  // In a real implementation, this would make an AJAX call
  const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
  if (notification) {
    const readStatus = notification.dataset.read === 'true';
    notification.dataset.read = readStatus ? 'false' : 'true';
    
    // Update the button text
    const button = notification.querySelector('button[onclick*="markAsRead"]');
    if (button) {
      button.innerHTML = readStatus ? 
        '<i class="fas fa-check mr-1"></i>Mark as Read' : 
        '<i class="fas fa-check mr-1"></i>Mark as Unread';
    }
    
    // Update visual indicators
    if (readStatus) {
      notification.classList.add('border-l-4', 'border-l-primary-500');
      notification.querySelector('h3').classList.add('font-bold');
    } else {
      notification.classList.remove('border-l-4', 'border-l-primary-500');
      notification.querySelector('h3').classList.remove('font-bold');
    }
  }
}

function markAllAsRead() {
  // In a real implementation, this would make an AJAX call
  const notifications = document.querySelectorAll('.notification-item[data-read="false"]');
  notifications.forEach(notification => {
    notification.dataset.read = 'true';
    notification.classList.remove('border-l-4', 'border-l-primary-500');
    notification.querySelector('h3').classList.remove('font-bold');
    
    const button = notification.querySelector('button[onclick*="markAsRead"]');
    if (button) {
      button.innerHTML = '<i class="fas fa-check mr-1"></i>Mark as Unread';
    }
  });
  
  // Update unread count
  document.getElementById('unreadCount').textContent = '0';
}

function viewNotification(notificationId) {
  // In a real implementation, this would open a detailed view
  alert('View notification details for ID: ' + notificationId);
}

function editNotification(notificationId) {
  // In a real implementation, this would open an edit form
  alert('Edit notification for ID: ' + notificationId);
}

function deleteNotification(notificationId) {
  if (confirm('Are you sure you want to delete this notification?')) {
    // In a real implementation, this would make an AJAX call
    const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
    if (notification) {
      notification.remove();
    }
  }
}

function createNotification() {
  document.getElementById('createNotificationModal').classList.remove('hidden');
}

function closeCreateModal() {
  document.getElementById('createNotificationModal').classList.add('hidden');
  document.getElementById('createNotificationForm').reset();
}

// Handle form submission
document.getElementById('createNotificationForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would make an AJAX call
  const formData = new FormData(this);
  console.log('Creating notification:', Object.fromEntries(formData));
  
  // Close modal and show success message
  closeCreateModal();
  alert('Notification created successfully!');
});

// Close modal when clicking outside
document.getElementById('createNotificationModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCreateModal();
  }
});
</script>
{% endblock %}