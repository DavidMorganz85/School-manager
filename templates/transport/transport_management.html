{% extends 'base.html' %}
{% load static %}

{% block title %}Transport Management - School Manager{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Transport Management</h1>
        <p class="text-gray-600">Manage school buses, routes, and track student transportation</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <button onclick="viewMap()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-map mr-2"></i>
          View Map
        </button>
        <button onclick="addRoute()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-plus mr-2"></i>
          Add Route
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Transport Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
            <i class="fas fa-bus text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Active Buses</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ active_buses }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
            <i class="fas fa-route text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Routes</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ total_routes }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
            <i class="fas fa-users text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Students Transported</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ students_transported }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
            <i class="fas fa-clock text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">On Time Rate</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ on_time_rate }}%</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Live Tracking Map -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-medium text-gray-900">Live Bus Tracking</h3>
      <div class="flex items-center space-x-2">
        <button onclick="refreshTracking()" class="inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-sync-alt mr-1"></i>
          Refresh
        </button>
        <button onclick="toggleFullscreen()" class="inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-expand mr-1"></i>
          Fullscreen
        </button>
      </div>
    </div>
  </div>
  <div class="p-6">
    <div class="bg-gray-100 rounded-lg h-96 flex items-center justify-center relative overflow-hidden">
      <!-- Map placeholder - in real implementation, this would be a Google Maps or OpenStreetMap integration -->
      <div class="text-center">
        <i class="fas fa-map-marked-alt text-4xl text-gray-400 mb-4"></i>
        <p class="text-gray-600">Interactive Map with Live Bus Locations</p>
        <p class="text-sm text-gray-500 mt-2">Real-time GPS tracking of all school buses</p>
      </div>
      
      <!-- Bus markers overlay -->
      <div class="absolute top-4 left-4 space-y-2">
        <div class="bg-white rounded-lg shadow-md p-3 max-w-xs">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-sm font-medium">Bus #001 - On Route</span>
          </div>
          <p class="text-xs text-gray-600 mt-1">Next stop: Main Street in 5 mins</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-3 max-w-xs">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
            <span class="text-sm font-medium">Bus #002 - Delayed</span>
          </div>
          <p class="text-xs text-gray-600 mt-1">Running 10 mins late</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-3 max-w-xs">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
            <span class="text-sm font-medium">Bus #003 - At School</span>
          </div>
          <p class="text-xs text-gray-600 mt-1">Loading students</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Routes Management -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Active Routes -->
  <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">Active Routes</h3>
    </div>
    <div class="p-6">
      <div class="space-y-4">
        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
              <i class="fas fa-bus text-white"></i>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-900">Route A - Downtown</h4>
              <p class="text-xs text-gray-600">Bus #001 • 15 students</p>
            </div>
          </div>
          <div class="text-right">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              On Time
            </span>
            <p class="text-xs text-gray-500 mt-1">Next: Oak Street</p>
          </div>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
              <i class="fas fa-bus text-white"></i>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-900">Route B - Suburbs</h4>
              <p class="text-xs text-gray-600">Bus #002 • 12 students</p>
            </div>
          </div>
          <div class="text-right">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              Delayed
            </span>
            <p class="text-xs text-gray-500 mt-1">10 mins late</p>
          </div>
        </div>
        
        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
              <i class="fas fa-bus text-white"></i>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-900">Route C - Industrial</h4>
              <p class="text-xs text-gray-600">Bus #003 • 8 students</p>
            </div>
          </div>
          <div class="text-right">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              At School
            </span>
            <p class="text-xs text-gray-500 mt-1">Loading</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Route Details -->
  <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">Route Details</h3>
    </div>
    <div class="p-6">
      <div class="space-y-4">
        <div class="border-l-4 border-green-500 pl-4">
          <h4 class="text-sm font-medium text-gray-900">Route A - Downtown</h4>
          <div class="mt-2 space-y-1">
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-green-500 mr-2"></i>
              School (Start) - 7:30 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-blue-500 mr-2"></i>
              Oak Street - 7:45 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-blue-500 mr-2"></i>
              Main Street - 8:00 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-red-500 mr-2"></i>
              School (End) - 8:15 AM
            </div>
          </div>
        </div>
        
        <div class="border-l-4 border-yellow-500 pl-4">
          <h4 class="text-sm font-medium text-gray-900">Route B - Suburbs</h4>
          <div class="mt-2 space-y-1">
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-green-500 mr-2"></i>
              School (Start) - 7:25 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-blue-500 mr-2"></i>
              Pine Avenue - 7:40 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-blue-500 mr-2"></i>
              Maple Street - 7:55 AM
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <i class="fas fa-circle text-red-500 mr-2"></i>
              School (End) - 8:10 AM
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Students on Transport -->
<div class="bg-white shadow-sm border border-gray-200 rounded-lg mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-medium text-gray-900">Students on Transport</h3>
      <div class="flex items-center space-x-2">
        <input type="text" placeholder="Search students..." class="block w-64 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
        <button onclick="exportTransportData()" class="inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-download mr-1"></i>
          Export
        </button>
      </div>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pickup Time</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                  <i class="fas fa-user text-gray-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">John Doe</div>
                <div class="text-sm text-gray-500">Grade 10A</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Route A - Downtown</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">7:45 AM</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              <i class="fas fa-check-circle mr-1"></i>Picked Up
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button onclick="trackStudent(1)" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-map-marker-alt"></i>
              </button>
              <button onclick="contactParent(1)" class="text-green-600 hover:text-green-900">
                <i class="fas fa-phone"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                  <i class="fas fa-user text-gray-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">Jane Smith</div>
                <div class="text-sm text-gray-500">Grade 9B</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Route B - Suburbs</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">7:40 AM</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              <i class="fas fa-clock mr-1"></i>Waiting
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button onclick="trackStudent(2)" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-map-marker-alt"></i>
              </button>
              <button onclick="contactParent(2)" class="text-green-600 hover:text-green-900">
                <i class="fas fa-phone"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                  <i class="fas fa-user text-gray-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">Bob Johnson</div>
                <div class="text-sm text-gray-500">Grade 11C</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Route C - Industrial</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">7:50 AM</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
              <i class="fas fa-exclamation-triangle mr-1"></i>Absent
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button onclick="trackStudent(3)" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-map-marker-alt"></i>
              </button>
              <button onclick="contactParent(3)" class="text-green-600 hover:text-green-900">
                <i class="fas fa-phone"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Add Route Modal -->
<div id="addRouteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Add New Route</h3>
        <button onclick="closeAddRouteModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="addRouteForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Route Name</label>
            <input type="text" id="routeName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Bus Number</label>
            <input type="text" id="busNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Driver</label>
          <select id="driverSelect" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
            <option value="">Select Driver</option>
            <option value="driver1">John Smith</option>
            <option value="driver2">Mary Johnson</option>
            <option value="driver3">David Brown</option>
          </select>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Start Time</label>
            <input type="time" id="startTime" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">End Time</label>
            <input type="time" id="endTime" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Route Stops</label>
          <div id="routeStops" class="mt-2 space-y-2">
            <div class="flex items-center space-x-2">
              <input type="text" placeholder="Stop name" class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
              <input type="time" class="border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
              <button type="button" onclick="removeStop(this)" class="text-red-600 hover:text-red-900">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <button type="button" onclick="addStop()" class="mt-2 inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-plus mr-1"></i>
            Add Stop
          </button>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeAddRouteModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Add Route
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
function addRoute() {
  document.getElementById('addRouteModal').classList.remove('hidden');
}

function closeAddRouteModal() {
  document.getElementById('addRouteModal').classList.add('hidden');
  document.getElementById('addRouteForm').reset();
  // Reset route stops
  const stopsContainer = document.getElementById('routeStops');
  stopsContainer.innerHTML = `
    <div class="flex items-center space-x-2">
      <input type="text" placeholder="Stop name" class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
      <input type="time" class="border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
      <button type="button" onclick="removeStop(this)" class="text-red-600 hover:text-red-900">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
}

function addStop() {
  const stopsContainer = document.getElementById('routeStops');
  const stopDiv = document.createElement('div');
  stopDiv.className = 'flex items-center space-x-2';
  stopDiv.innerHTML = `
    <input type="text" placeholder="Stop name" class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
    <input type="time" class="border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
    <button type="button" onclick="removeStop(this)" class="text-red-600 hover:text-red-900">
      <i class="fas fa-trash"></i>
    </button>
  `;
  stopsContainer.appendChild(stopDiv);
}

function removeStop(button) {
  button.parentElement.remove();
}

function viewMap() {
  // In a real implementation, this would open a full-screen map
  alert('Opening full-screen map view');
}

function refreshTracking() {
  // In a real implementation, this would refresh GPS data
  alert('Refreshing live tracking data...');
}

function toggleFullscreen() {
  // In a real implementation, this would toggle fullscreen mode
  alert('Toggling fullscreen mode');
}

function trackStudent(studentId) {
  // In a real implementation, this would show student's location
  alert('Tracking student: ' + studentId);
}

function contactParent(studentId) {
  // In a real implementation, this would initiate contact
  alert('Contacting parent for student: ' + studentId);
}

function exportTransportData() {
  // In a real implementation, this would export transport data
  alert('Exporting transport data...');
}

// Form submission
document.getElementById('addRouteForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would add the route
  const formData = new FormData(this);
  console.log('Adding route:', Object.fromEntries(formData));
  
  closeAddRouteModal();
  alert('Route added successfully!');
});

// Close modal when clicking outside
document.getElementById('addRouteModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAddRouteModal();
  }
});

// Set default times
document.getElementById('startTime').value = '07:30';
document.getElementById('endTime').value = '08:30';
</script>
{% endblock %}
