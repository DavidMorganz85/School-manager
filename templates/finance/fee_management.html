{% extends 'base.html' %}
{% load static %}

{% block title %}Fee Management - School Manager{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Fee Management</h1>
        <p class="text-gray-600">Manage student fees, payments, and financial records</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <button onclick="exportFees()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-download mr-2"></i>
          Export
        </button>
        <button onclick="createFee()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-plus mr-2"></i>
          Add Fee
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
            <i class="fas fa-dollar-sign text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Collected</dt>
            <dd class="text-3xl font-bold text-gray-900">${{ total_collected|floatformat:0 }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
            <i class="fas fa-clock text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Pending Payments</dt>
            <dd class="text-3xl font-bold text-gray-900">${{ pending_amount|floatformat:0 }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Overdue</dt>
            <dd class="text-3xl font-bold text-gray-900">${{ overdue_amount|floatformat:0 }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
            <i class="fas fa-percentage text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Collection Rate</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ collection_rate }}%</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Search Student</label>
        <input type="text" id="studentSearch" placeholder="Student name or ID" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Fee Status</label>
        <select id="statusFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <option value="">All Status</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Fee Type</label>
        <select id="typeFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <option value="">All Types</option>
          <option value="tuition">Tuition</option>
          <option value="library">Library</option>
          <option value="sports">Sports</option>
          <option value="transport">Transport</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
        <input type="date" id="dateFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
      </div>
    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="applyFilters()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
        <i class="fas fa-search mr-2"></i>
        Apply Filters
      </button>
    </div>
  </div>
</div>

<!-- Fees Table -->
<div class="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-medium text-gray-900">Fee Records</h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fee Type</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody id="feesTableBody" class="bg-white divide-y divide-gray-200">
        {% for fee in fees %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" class="fee-checkbox rounded border-gray-300 text-primary-600 focus:ring-primary-500" value="{{ fee.id }}">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                {% if fee.student.photo %}
                  <img class="h-10 w-10 rounded-full" src="{{ fee.student.photo.url }}" alt="{{ fee.student.user.get_full_name }}">
                {% else %}
                  <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                    <i class="fas fa-user text-gray-600"></i>
                  </div>
                {% endif %}
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">{{ fee.student.user.get_full_name }}</div>
                <div class="text-sm text-gray-500">{{ fee.student.user.username }}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fee.fee_type|title }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ fee.amount|floatformat:2 }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fee.due_date|date:"M d, Y" }}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if fee.status == 'paid' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-1"></i>Paid
              </span>
            {% elif fee.status == 'overdue' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                <i class="fas fa-exclamation-triangle mr-1"></i>Overdue
              </span>
            {% else %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                <i class="fas fa-clock mr-1"></i>Pending
              </span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            {% if fee.payment_date %}
              {{ fee.payment_date|date:"M d, Y" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              {% if fee.status != 'paid' %}
                <button onclick="recordPayment({{ fee.id }})" class="text-green-600 hover:text-green-900">
                  <i class="fas fa-credit-card"></i>
                </button>
              {% endif %}
              <button onclick="viewFee({{ fee.id }})" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-eye"></i>
              </button>
              <button onclick="editFee({{ fee.id }})" class="text-gray-600 hover:text-gray-900">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteFee({{ fee.id }})" class="text-red-600 hover:text-red-900">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="px-6 py-4 text-center text-gray-500">No fees found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Bulk Actions -->
<div id="bulkActions" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg border border-gray-200 p-4">
  <div class="flex items-center space-x-4">
    <span class="text-sm text-gray-600" id="selectedCount">0 selected</span>
    <button onclick="bulkRecordPayment()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
      <i class="fas fa-credit-card mr-2"></i>
      Record Payment
    </button>
    <button onclick="bulkSendReminder()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
      <i class="fas fa-envelope mr-2"></i>
      Send Reminder
    </button>
    <button onclick="bulkExport()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
      <i class="fas fa-download mr-2"></i>
      Export Selected
    </button>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Record Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="paymentForm" class="space-y-4">
        <input type="hidden" id="feeId" name="fee_id">
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Payment Amount</label>
          <input type="number" id="paymentAmount" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Payment Method</label>
          <select id="paymentMethod" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
            <option value="cash">Cash</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="credit_card">Credit Card</option>
            <option value="online">Online Payment</option>
            <option value="check">Check</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Payment Date</label>
          <input type="date" id="paymentDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Reference Number</label>
          <input type="text" id="referenceNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Notes</label>
          <textarea id="paymentNotes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closePaymentModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Record Payment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Fee Modal -->
<div id="createFeeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Create New Fee</h3>
        <button onclick="closeCreateFeeModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="createFeeForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Student</label>
          <select id="studentSelect" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
            <option value="">Select Student</option>
            <!-- Students will be populated here -->
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Fee Type</label>
          <select id="feeType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
            <option value="">Select Fee Type</option>
            <option value="tuition">Tuition Fee</option>
            <option value="library">Library Fee</option>
            <option value="sports">Sports Fee</option>
            <option value="transport">Transport Fee</option>
            <option value="exam">Exam Fee</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Amount</label>
          <input type="number" id="feeAmount" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Due Date</label>
          <input type="date" id="dueDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="feeDescription" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeCreateFeeModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Create Fee
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// Checkbox functionality
document.getElementById('selectAll').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.fee-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = this.checked;
  });
  updateBulkActions();
});

document.querySelectorAll('.fee-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', updateBulkActions);
});

function updateBulkActions() {
  const selectedCheckboxes = document.querySelectorAll('.fee-checkbox:checked');
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');
  
  if (selectedCheckboxes.length > 0) {
    bulkActions.classList.remove('hidden');
    selectedCount.textContent = `${selectedCheckboxes.length} selected`;
  } else {
    bulkActions.classList.add('hidden');
  }
}

function applyFilters() {
  // In a real implementation, this would make an AJAX call
  console.log('Applying filters...');
}

function recordPayment(feeId) {
  document.getElementById('feeId').value = feeId;
  document.getElementById('paymentModal').classList.remove('hidden');
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.add('hidden');
  document.getElementById('paymentForm').reset();
}

function createFee() {
  document.getElementById('createFeeModal').classList.remove('hidden');
}

function closeCreateFeeModal() {
  document.getElementById('createFeeModal').classList.add('hidden');
  document.getElementById('createFeeForm').reset();
}

function viewFee(feeId) {
  // In a real implementation, this would open a detailed view
  alert('View fee details for ID: ' + feeId);
}

function editFee(feeId) {
  // In a real implementation, this would open an edit form
  alert('Edit fee for ID: ' + feeId);
}

function deleteFee(feeId) {
  if (confirm('Are you sure you want to delete this fee?')) {
    // In a real implementation, this would make an AJAX call
    console.log('Deleting fee:', feeId);
  }
}

function bulkRecordPayment() {
  const selectedIds = Array.from(document.querySelectorAll('.fee-checkbox:checked')).map(cb => cb.value);
  if (selectedIds.length > 0) {
    alert('Recording payment for fees: ' + selectedIds.join(', '));
  }
}

function bulkSendReminder() {
  const selectedIds = Array.from(document.querySelectorAll('.fee-checkbox:checked')).map(cb => cb.value);
  if (selectedIds.length > 0) {
    alert('Sending reminders for fees: ' + selectedIds.join(', '));
  }
}

function bulkExport() {
  const selectedIds = Array.from(document.querySelectorAll('.fee-checkbox:checked')).map(cb => cb.value);
  if (selectedIds.length > 0) {
    alert('Exporting fees: ' + selectedIds.join(', '));
  }
}

function exportFees() {
  // In a real implementation, this would generate and download a file
  alert('Exporting all fees...');
}

// Form submissions
document.getElementById('paymentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would make an AJAX call
  const formData = new FormData(this);
  console.log('Recording payment:', Object.fromEntries(formData));
  
  closePaymentModal();
  alert('Payment recorded successfully!');
});

document.getElementById('createFeeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would make an AJAX call
  const formData = new FormData(this);
  console.log('Creating fee:', Object.fromEntries(formData));
  
  closeCreateFeeModal();
  alert('Fee created successfully!');
});

// Close modals when clicking outside
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePaymentModal();
  }
});

document.getElementById('createFeeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCreateFeeModal();
  }
});

// Set today's date as default for payment date
document.getElementById('paymentDate').valueAsDate = new Date();
</script>
{% endblock %}
