{% extends 'base.html' %}
{% load static %}

{% block title %}Messaging System - School Manager{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Messaging System</h1>
        <p class="text-gray-600">Communicate with students, parents, and staff members</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <button onclick="composeMessage()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-plus mr-2"></i>
          New Message
        </button>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Sidebar -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Conversations</h3>
      </div>
      
      <!-- Search -->
      <div class="p-4 border-b border-gray-200">
        <div class="relative">
          <input type="text" id="conversationSearch" placeholder="Search conversations..." class="block w-full pl-10 pr-3 py-2 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
        </div>
      </div>
      
      <!-- Conversation List -->
      <div class="max-h-96 overflow-y-auto">
        <div id="conversationsList" class="space-y-1">
          <!-- Sample conversations -->
          <div class="conversation-item p-3 hover:bg-gray-50 cursor-pointer border-l-4 border-primary-500 bg-primary-50" onclick="selectConversation(1)">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-white"></i>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-gray-900 truncate">John Doe (Parent)</p>
                  <p class="text-xs text-gray-500">2 min ago</p>
                </div>
                <p class="text-sm text-gray-600 truncate">Thank you for the update about...</p>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">1</span>
              </div>
            </div>
          </div>
          
          <div class="conversation-item p-3 hover:bg-gray-50 cursor-pointer" onclick="selectConversation(2)">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-chalkboard-teacher text-white"></i>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-gray-900 truncate">Ms. Johnson (Teacher)</p>
                  <p class="text-xs text-gray-500">1 hour ago</p>
                </div>
                <p class="text-sm text-gray-600 truncate">Can we schedule a meeting...</p>
              </div>
            </div>
          </div>
          
          <div class="conversation-item p-3 hover:bg-gray-50 cursor-pointer" onclick="selectConversation(3)">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-users text-white"></i>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-gray-900 truncate">Grade 10 Students</p>
                  <p class="text-xs text-gray-500">3 hours ago</p>
                </div>
                <p class="text-sm text-gray-600 truncate">Reminder: Assignment due tomorrow</p>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">3</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main Chat Area -->
  <div class="lg:col-span-3">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-96 flex flex-col">
      <!-- Chat Header -->
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white"></i>
            </div>
            <div>
              <h3 class="text-lg font-medium text-gray-900" id="chatTitle">Select a conversation</h3>
              <p class="text-sm text-gray-500" id="chatSubtitle">Choose a conversation to start messaging</p>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="callUser()" class="p-2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-phone"></i>
            </button>
            <button onclick="videoCall()" class="p-2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-video"></i>
            </button>
            <button onclick="moreOptions()" class="p-2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-ellipsis-v"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Messages Area -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesArea">
        <div class="text-center text-gray-500 py-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>Select a conversation to start messaging</p>
        </div>
      </div>
      
      <!-- Message Input -->
      <div class="p-4 border-t border-gray-200">
        <div class="flex items-center space-x-2">
          <button onclick="attachFile()" class="p-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-paperclip"></i>
          </button>
          <button onclick="attachImage()" class="p-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-image"></i>
          </button>
          <div class="flex-1">
            <input type="text" id="messageInput" placeholder="Type a message..." class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" disabled>
          </div>
          <button onclick="sendMessage()" class="p-2 text-primary-600 hover:text-primary-700" disabled id="sendButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Compose Message Modal -->
<div id="composeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Compose Message</h3>
        <button onclick="closeComposeModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="composeForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">To</label>
          <div class="mt-1">
            <select id="recipientType" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" onchange="updateRecipients()">
              <option value="">Select recipient type</option>
              <option value="individual">Individual</option>
              <option value="class">Class</option>
              <option value="grade">Grade</option>
              <option value="all_students">All Students</option>
              <option value="all_teachers">All Teachers</option>
              <option value="all_parents">All Parents</option>
            </select>
          </div>
          <div id="recipientSelect" class="mt-2 hidden">
            <select id="recipientList" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
              <option value="">Select recipient</option>
            </select>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Subject</label>
          <input type="text" id="messageSubject" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Message</label>
          <textarea id="messageContent" rows="6" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Priority</label>
          <select id="messagePriority" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Send Options</label>
          <div class="mt-2 space-y-2">
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" id="sendEmail">
              <span class="ml-2 text-sm text-gray-700">Send via Email</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" id="sendSMS">
              <span class="ml-2 text-sm text-gray-700">Send via SMS</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" class="form-checkbox" id="scheduleMessage">
              <span class="ml-2 text-sm text-gray-700">Schedule for later</span>
            </label>
          </div>
        </div>
        
        <div id="scheduleOptions" class="hidden">
          <label class="block text-sm font-medium text-gray-700">Schedule Date & Time</label>
          <div class="grid grid-cols-2 gap-2 mt-1">
            <input type="date" id="scheduleDate" class="border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
            <input type="time" id="scheduleTime" class="border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeComposeModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Send Message
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
let selectedConversationId = null;

function composeMessage() {
  document.getElementById('composeModal').classList.remove('hidden');
}

function closeComposeModal() {
  document.getElementById('composeModal').classList.add('hidden');
  document.getElementById('composeForm').reset();
  document.getElementById('recipientSelect').classList.add('hidden');
  document.getElementById('scheduleOptions').classList.add('hidden');
}

function updateRecipients() {
  const recipientType = document.getElementById('recipientType').value;
  const recipientSelect = document.getElementById('recipientSelect');
  const recipientList = document.getElementById('recipientList');
  
  if (recipientType === 'individual') {
    recipientSelect.classList.remove('hidden');
    recipientList.innerHTML = `
      <option value="">Select recipient</option>
      <option value="john_doe">John Doe (Parent)</option>
      <option value="jane_smith">Jane Smith (Student)</option>
      <option value="ms_johnson">Ms. Johnson (Teacher)</option>
    `;
  } else if (recipientType === 'class') {
    recipientSelect.classList.remove('hidden');
    recipientList.innerHTML = `
      <option value="">Select class</option>
      <option value="grade_9_a">Grade 9A</option>
      <option value="grade_10_b">Grade 10B</option>
      <option value="grade_11_c">Grade 11C</option>
    `;
  } else {
    recipientSelect.classList.add('hidden');
  }
}

function selectConversation(conversationId) {
  selectedConversationId = conversationId;
  
  // Remove active class from all conversations
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.classList.remove('border-l-4', 'border-primary-500', 'bg-primary-50');
  });
  
  // Add active class to selected conversation
  event.currentTarget.classList.add('border-l-4', 'border-primary-500', 'bg-primary-50');
  
  // Update chat header and enable input
  document.getElementById('chatTitle').textContent = 'John Doe (Parent)';
  document.getElementById('chatSubtitle').textContent = 'Online';
  document.getElementById('messageInput').disabled = false;
  document.getElementById('sendButton').disabled = false;
  
  // Load messages for this conversation
  loadMessages(conversationId);
}

function loadMessages(conversationId) {
  const messagesArea = document.getElementById('messagesArea');
  
  // Sample messages
  const messages = [
    {
      id: 1,
      sender: 'John Doe',
      content: 'Hello, I wanted to ask about my son\'s progress in mathematics.',
      timestamp: '10:30 AM',
      isOwn: false
    },
    {
      id: 2,
      sender: 'You',
      content: 'Hello Mr. Doe! I\'d be happy to discuss your son\'s progress. He has been doing well in class.',
      timestamp: '10:32 AM',
      isOwn: true
    },
    {
      id: 3,
      sender: 'John Doe',
      content: 'That\'s great to hear. Could we schedule a meeting to discuss this further?',
      timestamp: '10:35 AM',
      isOwn: false
    }
  ];
  
  messagesArea.innerHTML = '';
  
  messages.forEach(message => {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${message.isOwn ? 'justify-end' : 'justify-start'}`;
    
    messageDiv.innerHTML = `
      <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${message.isOwn ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-900'}">
        <p class="text-sm">${message.content}</p>
        <p class="text-xs ${message.isOwn ? 'text-primary-100' : 'text-gray-500'} mt-1">${message.timestamp}</p>
      </div>
    `;
    
    messagesArea.appendChild(messageDiv);
  });
  
  // Scroll to bottom
  messagesArea.scrollTop = messagesArea.scrollHeight;
}

function sendMessage() {
  const messageInput = document.getElementById('messageInput');
  const message = messageInput.value.trim();
  
  if (message && selectedConversationId) {
    // In a real implementation, this would send the message via AJAX
    console.log('Sending message:', message);
    
    // Add message to chat
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex justify-end';
    
    const now = new Date();
    const timestamp = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
      <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-primary-600 text-white">
        <p class="text-sm">${message}</p>
        <p class="text-xs text-primary-100 mt-1">${timestamp}</p>
      </div>
    `;
    
    messagesArea.appendChild(messageDiv);
    messageInput.value = '';
    
    // Scroll to bottom
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }
}

function attachFile() {
  // In a real implementation, this would open file picker
  alert('Attach file functionality');
}

function attachImage() {
  // In a real implementation, this would open image picker
  alert('Attach image functionality');
}

function callUser() {
  // In a real implementation, this would initiate a call
  alert('Call functionality');
}

function videoCall() {
  // In a real implementation, this would initiate a video call
  alert('Video call functionality');
}

function moreOptions() {
  // In a real implementation, this would show more options
  alert('More options');
}

// Form submission
document.getElementById('composeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would send the message
  const formData = new FormData(this);
  console.log('Sending message:', Object.fromEntries(formData));
  
  closeComposeModal();
  alert('Message sent successfully!');
});

// Schedule message toggle
document.getElementById('scheduleMessage').addEventListener('change', function() {
  const scheduleOptions = document.getElementById('scheduleOptions');
  if (this.checked) {
    scheduleOptions.classList.remove('hidden');
  } else {
    scheduleOptions.classList.add('hidden');
  }
});

// Send message on Enter key
document.getElementById('messageInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Close modal when clicking outside
document.getElementById('composeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeComposeModal();
  }
});

// Search conversations
document.getElementById('conversationSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const conversations = document.querySelectorAll('.conversation-item');
  
  conversations.forEach(conversation => {
    const text = conversation.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      conversation.style.display = 'block';
    } else {
      conversation.style.display = 'none';
    }
  });
});
</script>
{% endblock %}
