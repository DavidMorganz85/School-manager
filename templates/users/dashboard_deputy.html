{% extends 'base.html' %}
{% block content %}
<!-- Topbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand">Welcome, {{ user.get_full_name }}!</span>
    <form class="d-flex">
      <input class="form-control me-2" type="search" placeholder="Search..." aria-label="Search">
    </form>
    <div class="dropdown">
      <a class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        <img src="{{ user.profile_photo.url }}" alt="Profile" class="rounded-circle" width="32" height="32">
        {{ user.username }}
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#">Settings</a></li>
        <li><a class="dropdown-item" href="#">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Total Students</h6>
        <h3>{{ total_students }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Total Teachers</h6>
        <h3>{{ total_teachers }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Classes</h6>
        <h3>{{ total_classes }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Attendance</h6>
        <h3>{{ attendance_summary }}%</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Upcoming Exams</h6>
        <h3>{{ upcoming_exams }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h6>Events</h6>
        <h3>{{ upcoming_events }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="mb-4 d-flex flex-wrap gap-2">
  <a href="#" class="btn btn-primary"><i class="fa fa-check"></i> Approve Class Reports</a>
  <a href="#" class="btn btn-success"><i class="fa fa-bullhorn"></i> Send Announcement</a>
  <a href="#" class="btn btn-info"><i class="fa fa-eye"></i> View Class Attendance</a>
</div>

<!-- Charts -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Attendance Trends per Class</h6>
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Academic Performance by Class</h6>
        <canvas id="performanceChart"></canvas>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const attendanceLabels = {{ attendance_labels|safe }};
  const attendanceData = {{ attendance_data|safe }};
  const attCtx = document.getElementById('attendanceChart').getContext('2d');
  new Chart(attCtx, {
    type: 'bar',
    data: {
      labels: attendanceLabels,
      datasets: [{
        label: 'Attendance %',
        data: attendanceData,
        backgroundColor: 'rgba(13, 27, 42, 0.7)',
        borderRadius: 6,
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  const perfLabels = {{ performance_labels|safe }};
  const perfData = {{ performance_data|safe }};
  const perfCtx = document.getElementById('performanceChart').getContext('2d');
  new Chart(perfCtx, {
    type: 'line',
    data: {
      labels: perfLabels,
      datasets: [{
        label: 'Average Grade',
        data: perfData,
        borderColor: 'rgba(0, 123, 255, 0.7)',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
</script>

<!-- Classes Overview -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Classes Overview</h6>
    <table class="table table-bordered table-sm">
      <thead>
        <tr><th>Class</th><th>Section</th><th>Teacher</th><th>Attendance</th><th>Performance</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for c in classes %}
          <tr {% if c.needs_attention %}class="table-warning"{% endif %}>
            <td>{{ c.name }}</td>
            <td>{{ c.section }}</td>
            <td>{{ c.teacher }}</td>
            <td>{{ c.attendance }}%</td>
            <td>{{ c.performance }}</td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-info">View</a>
              {% if c.needs_attention %}<span class="badge bg-danger ms-2">Attention</span>{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">No classes found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Teachers Overview -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Teachers Overview</h6>
    <table class="table table-bordered table-sm">
      <thead>
        <tr><th>Name</th><th>Subjects</th><th>Submissions</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for t in teachers %}
          <tr>
            <td>{{ t.name }}</td>
            <td>{{ t.subjects }}</td>
            <td>{{ t.submissions }}</td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-success">Approve</a>
              <a href="#" class="btn btn-sm btn-outline-danger">Request Correction</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No teachers found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Students & Academic Reports -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Student & Academic Reports</h6>
    <table class="table table-bordered table-sm">
      <thead>
        <tr><th>Name</th><th>Class</th><th>Attendance</th><th>Grade</th><th>Discipline</th><th>At Risk</th></tr>
      </thead>
      <tbody>
        {% for s in students %}
          <tr {% if s.at_risk %}class="table-danger"{% endif %}>
            <td>{{ s.name }}</td>
            <td>{{ s.class }}</td>
            <td>{{ s.attendance }}%</td>
            <td>{{ s.grade }}</td>
            <td>{{ s.discipline }}</td>
            <td>{% if s.at_risk %}<span class="badge bg-danger">Alert</span>{% endif %}</td>
          </tr>
        {% empty %}
          <tr><td colspan="6">No students found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Exams & Timetable -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Exams & Timetable</h6>
    <table class="table table-bordered table-sm">
      <thead>
        <tr><th>Exam</th><th>Class</th><th>Subject</th><th>Date</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for e in exams %}
          <tr>
            <td>{{ e.name }}</td>
            <td>{{ e.class }}</td>
            <td>{{ e.subject }}</td>
            <td>{{ e.date }}</td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-success">Approve</a>
              <a href="#" class="btn btn-sm btn-outline-danger">Request Correction</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">No exams found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Notifications & Communication -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Notifications & Communication</h6>
    <ul>
      {% for n in notifications %}
        <li>{{ n.message }} <span class="text-muted">{{ n.sent_at }}</span></li>
      {% empty %}
        <li>No notifications.</li>
      {% endfor %}
    </ul>
    <form class="mt-3">
      <div class="input-group">
        <input type="text" name="announcement" class="form-control" placeholder="Send announcement...">
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
