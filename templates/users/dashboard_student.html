<!-- Library / Resources Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Library / Resources</h6>
    <strong>Borrowed Books:</strong>
    <ul>
      {% for record in borrowed_books %}
        <li>
          <strong>{{ record.book.title }}</strong> by {{ record.book.author }}<br>
          Due: <span class="text-danger">{{ record.due_date }}</span>
          {% if record.fine and record.fine > 0 %}<span class="badge bg-warning ms-2">Fine: {{ record.fine }}</span>{% endif %}
        </li>
      {% empty %}
        <li>No borrowed books.</li>
      {% endfor %}
    </ul>
    <strong>Downloadable Materials:</strong>
    <ul>
      {% for material in downloadable_materials %}
        <li>
          <a href="{{ material.file.url }}" download>{{ material.title }}</a> <span class="text-muted">Uploaded by {{ material.uploader.get_full_name }}</span>
        </li>
      {% empty %}
        <li>No materials available.</li>
      {% endfor %}
    </ul>
    <a href="#" class="btn btn-outline-primary btn-sm mt-2"><i class="fa fa-book"></i> Request New Book/Material</a>
  </div>
</div>
<!-- Notifications / Messages Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Notifications & Messages</h6>
    <ul id="notif-list">
      {% for note in notifications %}
        <li {% if not note.read %}class="fw-bold"{% endif %}>
          {{ note.message }} <span class="text-muted">{{ note.sent_at }}</span>
          {% if not note.read %}
            <button class="btn btn-sm btn-outline-success ms-2" onclick="markRead({{ note.id }})">Mark as read</button>
          {% endif %}
        </li>
      {% empty %}
        <li>No notifications or messages.</li>
      {% endfor %}
    </ul>
    <form id="send-message-form" class="mt-3">
      <div class="input-group">
        <input type="text" name="message" class="form-control" placeholder="Send a message to admin..." required>
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
    <div id="msg-status" class="mt-2"></div>
  </div>
</div>
<script>
function markRead(id) {
  fetch('', {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=mark_read&notif_id=${id}`
  }).then(r => r.json()).then(data => {
    if (data.success) location.reload();
  });
}
document.getElementById('send-message-form').onsubmit = function(e) {
  e.preventDefault();
  const msg = this.message.value;
  fetch('', {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=send_message&message=${encodeURIComponent(msg)}`
  }).then(r => r.json()).then(data => {
    document.getElementById('msg-status').textContent = data.success ? 'Message sent!' : (data.error || 'Error sending message');
    if (data.success) this.reset();
  });
}
</script>
<!-- Class & Subject Info Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Class & Subject Info</h6>
    <strong>Class:</strong> {{ student_profile.school_class }}<br>
    <strong>Subjects:</strong>
    <ul>
      {% for subject in subjects %}
        <li>{{ subject.name }} (Teacher: {{ subject.teacher }})</li>
      {% empty %}
        <li>No subjects assigned.</li>
      {% endfor %}
    </ul>
    <strong>Assigned Teachers:</strong>
    <ul>
      {% for teacher in teachers %}
        <li>{{ teacher.user.get_full_name }}</li>
      {% empty %}
        <li>No teachers assigned.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Timetable Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Timetable</h6>
    <table class="table table-bordered table-sm">
      <thead>
        <tr><th>Day</th><th>Period</th><th>Subject</th><th>Teacher</th></tr>
      </thead>
      <tbody>
        {% for entry in timetable %}
          <tr>
            <td>{{ entry.day }}</td>
            <td>{{ entry.period }}</td>
            <td>{{ entry.subject.name }}</td>
            <td>{{ entry.teacher.user.get_full_name }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No timetable available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<!-- Fees & Finance Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Fees & Finance</h6>
    <strong>Fee Balance:</strong> {{ fee_balance }}<br>
    <strong>Invoices:</strong>
    <ul>
      {% for invoice in invoices %}
        <li>
          Invoice #{{ invoice.id }} - {{ invoice.total }} - {{ invoice.issued_date }}
          {% if invoice.paid %}<span class="badge bg-success">Paid</span>{% else %}<span class="badge bg-warning">Unpaid</span>{% endif %}
          <a href="#" class="btn btn-sm btn-outline-secondary ms-2">Download</a>
        </li>
      {% empty %}
        <li>No invoices found.</li>
      {% endfor %}
    </ul>
    <strong>Payment History:</strong>
    <ul>
      {% for payment in payments %}
        <li>{{ payment.amount }} on {{ payment.date_paid }} <span class="text-muted">Invoice: {{ payment.invoice }}</span></li>
      {% empty %}
        <li>No payments found.</li>
      {% endfor %}
    </ul>
  </div>
</div>
<!-- Profile Section -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Profile</h6>
    <div class="row">
      <div class="col-md-2 text-center">
        <img src="{{ user.profile_photo.url }}" alt="Profile Photo" class="rounded-circle mb-2" width="80" height="80">
      </div>
      <div class="col-md-10">
        <strong>Name:</strong> {{ user.get_full_name }}<br>
        <strong>Admission No:</strong> {{ student_profile.id }}<br>
        <strong>Class/Section:</strong> {{ student_profile.school_class }}<br>
        <strong>Date of Birth:</strong> {{ student_profile.date_of_birth }}<br>
        <strong>Gender:</strong> {{ user.gender|default:"-" }}<br>
        <strong>Address:</strong> {{ student_profile.address }}<br>
        <strong>Parent/Guardian:</strong> {{ student_profile.parent.get_full_name }}<br>
        <strong>Contact:</strong> {{ student_profile.parent.email }}<br>
        <a href="#" class="btn btn-outline-primary btn-sm mt-2">Edit Profile</a>
        <a href="#" class="btn btn-outline-secondary btn-sm mt-2">Change Password</a>
      </div>
    </div>
  </div>
</div>
{% extends 'base.html' %}
{% block content %}
<!-- Topbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand">Welcome, {{ user.first_name }}!</span>
    <form class="d-flex">
      <input class="form-control me-2" type="search" placeholder="Search..." aria-label="Search">
    </form>
    <div class="dropdown">
      <a class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        <img src="{{ user.profile_photo.url }}" alt="Profile" class="rounded-circle" width="32" height="32">
        {{ user.username }}
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#">Settings</a></li>
        <li><a class="dropdown-item" href="#">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Quick Metrics Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6>Total Subjects</h6>
        <h3>{{ subjects_count }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6>Attendance %</h6>
        <h3>{{ attendance_percent }}%</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6>Latest Exam Score</h6>
        <h3>{{ latest_exam_score }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6>Fee Balance</h6>
        <h3>{{ fee_balance }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="mb-4 d-flex flex-wrap gap-2">
  <a href="#" class="btn btn-primary"><i class="fa fa-download"></i> Download Report Card</a>
  <a href="#" class="btn btn-success"><i class="fa fa-calendar"></i> View Timetable</a>
  <a href="#" class="btn btn-warning"><i class="fa fa-credit-card"></i> Pay Fees</a>
  <a href="#" class="btn btn-info"><i class="fa fa-book"></i> Request Library Book</a>
  <a href="#" class="btn btn-secondary"><i class="fa fa-envelope"></i> Contact Admin</a>
</div>
<style>
  @media (max-width: 768px) {
    .sidebar { width: 100px; }
    .content { margin-left: 0; padding: 5px; }
    .card { margin-bottom: 12px; }
    .navbar-brand, .dropdown-toggle { font-size: 0.95rem; }
    .table th, .table td { font-size: 0.85rem; }
    .mb-4 { margin-bottom: 10px !important; }
    .btn { font-size: 0.95rem; padding: 6px 10px; }
    .input-group { flex-direction: column; }
    .input-group .form-control, .input-group .btn { width: 100%; margin-bottom: 4px; }
  }
</style>

<!-- Charts & Graphs -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Attendance Trend</h6>
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Grade Progress</h6>
        <canvas id="gradeChart"></canvas>
        <div class="mt-3">
          <strong>GPA:</strong> {{ gpa }}
          <a href="#" class="btn btn-outline-primary btn-sm float-end"><i class="fa fa-download"></i> Download Report Card</a>
        </div>
      </div>
    </div>
  </div>
<!-- Chart.js for Grade Progress -->
<script>
  const gradeLabels = {{ grade_labels|safe }};
  const gradeData = {{ grade_data|safe }};
  const gradeCtx = document.getElementById('gradeChart').getContext('2d');
  new Chart(gradeCtx, {
    type: 'line',
    data: {
      labels: gradeLabels,
      datasets: [{
        label: 'Exam Score',
        data: gradeData,
        borderColor: 'rgba(0, 123, 255, 0.7)',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true, grid: { display: false } }
      }
    }
  });
</script>
</div>

<!-- Chart.js for Attendance -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const attendanceLabels = {{ attendance_labels|safe }};
  const attendanceData = {{ attendance_data|safe }};
  const ctx = document.getElementById('attendanceChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: attendanceLabels,
      datasets: [{
        label: 'Days Present',
        data: attendanceData,
        backgroundColor: 'rgba(13, 27, 42, 0.7)',
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true, grid: { display: false } }
      }
    }
  });
</script>

<!-- Announcements & Notifications -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Recent Announcements</h6>
    <ul>
      {% for note in notifications %}
        <li>{{ note.message }} <span class="text-muted">{{ note.date }}</span></li>
      {% empty %}
        <li>No announcements.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Collapsible Sidebar Navigation (already in base.html) -->

<!-- Responsive layout and additional sections can be added below -->
{% endblock %}
