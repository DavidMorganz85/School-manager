{% extends 'base.html' %}
{% load static %}

{% block title %}Digital Library - School Manager{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Digital Library</h1>
        <p class="text-gray-600">Access e-books, resources, and manage library operations</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <button onclick="uploadResource()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-upload mr-2"></i>
          Upload Resource
        </button>
        <button onclick="addBook()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          <i class="fas fa-plus mr-2"></i>
          Add Book
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Library Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
            <i class="fas fa-book text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Books</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ total_books }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
            <i class="fas fa-book-open text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Available</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ available_books }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
            <i class="fas fa-hand-holding text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Borrowed</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ borrowed_books }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow-sm border border-gray-200 rounded-lg">
    <div class="p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
            <i class="fas fa-users text-white"></i>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Active Borrowers</dt>
            <dd class="text-3xl font-bold text-gray-900">{{ active_borrowers }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <button onclick="browseBooks()" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200">
    <i class="fas fa-search text-blue-600 text-2xl mr-3"></i>
    <span class="text-sm font-medium text-blue-900">Browse Books</span>
  </button>
  <button onclick="viewBorrowed()" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200">
    <i class="fas fa-list text-green-600 text-2xl mr-3"></i>
    <span class="text-sm font-medium text-green-900">My Borrowed Books</span>
  </button>
  <button onclick="viewReservations()" class="flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors duration-200">
    <i class="fas fa-bookmark text-yellow-600 text-2xl mr-3"></i>
    <span class="text-sm font-medium text-yellow-900">Reservations</span>
  </button>
  <button onclick="viewHistory()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors duration-200">
    <i class="fas fa-history text-purple-600 text-2xl mr-3"></i>
    <span class="text-sm font-medium text-purple-900">Borrowing History</span>
  </button>
</div>

<!-- Search and Filters -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
        <div class="relative">
          <input type="text" id="bookSearch" placeholder="Search books, authors, ISBN..." class="block w-full pl-10 pr-3 py-2 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
        <select id="categoryFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <option value="">All Categories</option>
          <option value="fiction">Fiction</option>
          <option value="non-fiction">Non-Fiction</option>
          <option value="textbook">Textbook</option>
          <option value="reference">Reference</option>
          <option value="children">Children</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
        <select id="availabilityFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <option value="">All</option>
          <option value="available">Available</option>
          <option value="borrowed">Borrowed</option>
          <option value="reserved">Reserved</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
        <select id="sortFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          <option value="title">Title</option>
          <option value="author">Author</option>
          <option value="date_added">Date Added</option>
          <option value="popularity">Popularity</option>
        </select>
      </div>
    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="applyFilters()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
        <i class="fas fa-search mr-2"></i>
        Search
      </button>
    </div>
  </div>
</div>

<!-- Books Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8" id="booksGrid">
  {% for book in books %}
  <div class="book-card bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
    <div class="p-4">
      <!-- Book Cover -->
      <div class="aspect-w-3 aspect-h-4 mb-4">
        {% if book.cover_image %}
          <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="w-full h-48 object-cover rounded-lg">
        {% else %}
          <div class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center">
            <i class="fas fa-book text-gray-400 text-4xl"></i>
          </div>
        {% endif %}
      </div>
      
      <!-- Book Info -->
      <div class="space-y-2">
        <h3 class="text-lg font-semibold text-gray-900 line-clamp-2">{{ book.title }}</h3>
        <p class="text-sm text-gray-600">by {{ book.author }}</p>
        <p class="text-xs text-gray-500">{{ book.category|title }} â€¢ {{ book.pages }} pages</p>
        
        <!-- Availability Status -->
        <div class="flex items-center justify-between">
          {% if book.available_copies > 0 %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              <i class="fas fa-check-circle mr-1"></i>Available
            </span>
          {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
              <i class="fas fa-times-circle mr-1"></i>Unavailable
            </span>
          {% endif %}
          
          <span class="text-xs text-gray-500">{{ book.available_copies }}/{{ book.total_copies }} copies</span>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex space-x-2 pt-2">
          {% if book.available_copies > 0 %}
            <button onclick="borrowBook({{ book.id }})" class="flex-1 bg-primary-600 text-white text-xs font-medium py-2 px-3 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
              <i class="fas fa-hand-holding mr-1"></i>Borrow
            </button>
          {% else %}
            <button onclick="reserveBook({{ book.id }})" class="flex-1 bg-yellow-600 text-white text-xs font-medium py-2 px-3 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <i class="fas fa-bookmark mr-1"></i>Reserve
            </button>
          {% endif %}
          
          <button onclick="viewBook({{ book.id }})" class="bg-gray-200 text-gray-700 text-xs font-medium py-2 px-3 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-span-full text-center py-12">
    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-book text-gray-400 text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No books found</h3>
    <p class="text-gray-500">Try adjusting your search criteria or add some books to the library.</p>
  </div>
  {% endfor %}
</div>

<!-- Borrowed Books Section -->
<div class="bg-white shadow-sm border border-gray-200 rounded-lg mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-medium text-gray-900">Currently Borrowed Books</h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrowed Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody id="borrowedBooksTable" class="bg-white divide-y divide-gray-200">
        {% for loan in borrowed_books %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                {% if loan.book.cover_image %}
                  <img class="h-10 w-10 rounded object-cover" src="{{ loan.book.cover_image.url }}" alt="{{ loan.book.title }}">
                {% else %}
                  <div class="h-10 w-10 rounded bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-book text-gray-400"></i>
                  </div>
                {% endif %}
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">{{ loan.book.title }}</div>
                <div class="text-sm text-gray-500">by {{ loan.book.author }}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ loan.borrowed_date|date:"M d, Y" }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ loan.due_date|date:"M d, Y" }}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if loan.is_overdue %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                <i class="fas fa-exclamation-triangle mr-1"></i>Overdue
              </span>
            {% elif loan.days_remaining <= 3 %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                <i class="fas fa-clock mr-1"></i>Due Soon
              </span>
            {% else %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-1"></i>On Time
              </span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button onclick="renewBook({{ loan.id }})" class="text-blue-600 hover:text-blue-900">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button onclick="returnBook({{ loan.id }})" class="text-green-600 hover:text-green-900">
                <i class="fas fa-undo"></i>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-6 py-4 text-center text-gray-500">No borrowed books</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Book Modal -->
<div id="addBookModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Add New Book</h3>
        <button onclick="closeAddBookModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" id="bookTitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Author</label>
            <input type="text" id="bookAuthor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">ISBN</label>
            <input type="text" id="bookISBN" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Category</label>
            <select id="bookCategory" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
              <option value="">Select Category</option>
              <option value="fiction">Fiction</option>
              <option value="non-fiction">Non-Fiction</option>
              <option value="textbook">Textbook</option>
              <option value="reference">Reference</option>
              <option value="children">Children</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Pages</label>
            <input type="number" id="bookPages" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Total Copies</label>
            <input type="number" id="bookCopies" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" required>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="bookDescription" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Cover Image</label>
          <input type="file" id="bookCover" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeAddBookModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
            Add Book
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
function addBook() {
  document.getElementById('addBookModal').classList.remove('hidden');
}

function closeAddBookModal() {
  document.getElementById('addBookModal').classList.add('hidden');
  document.getElementById('addBookForm').reset();
}

function borrowBook(bookId) {
  if (confirm('Are you sure you want to borrow this book?')) {
    // In a real implementation, this would make an AJAX call
    alert('Book borrowed successfully!');
  }
}

function reserveBook(bookId) {
  if (confirm('Are you sure you want to reserve this book?')) {
    // In a real implementation, this would make an AJAX call
    alert('Book reserved successfully!');
  }
}

function viewBook(bookId) {
  // In a real implementation, this would open book details
  alert('View book details for ID: ' + bookId);
}

function renewBook(loanId) {
  if (confirm('Are you sure you want to renew this book?')) {
    // In a real implementation, this would make an AJAX call
    alert('Book renewed successfully!');
  }
}

function returnBook(loanId) {
  if (confirm('Are you sure you want to return this book?')) {
    // In a real implementation, this would make an AJAX call
    alert('Book returned successfully!');
  }
}

function browseBooks() {
  // In a real implementation, this would show all books
  alert('Browse all books');
}

function viewBorrowed() {
  // In a real implementation, this would show borrowed books
  alert('View borrowed books');
}

function viewReservations() {
  // In a real implementation, this would show reservations
  alert('View reservations');
}

function viewHistory() {
  // In a real implementation, this would show borrowing history
  alert('View borrowing history');
}

function uploadResource() {
  // In a real implementation, this would open upload dialog
  alert('Upload resource');
}

function applyFilters() {
  // In a real implementation, this would filter books
  console.log('Applying filters...');
}

// Form submission
document.getElementById('addBookForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // In a real implementation, this would add the book
  const formData = new FormData(this);
  console.log('Adding book:', Object.fromEntries(formData));
  
  closeAddBookModal();
  alert('Book added successfully!');
});

// Close modal when clicking outside
document.getElementById('addBookModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAddBookModal();
  }
});

// Search functionality
document.getElementById('bookSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const bookCards = document.querySelectorAll('.book-card');
  
  bookCards.forEach(card => {
    const title = card.querySelector('h3').textContent.toLowerCase();
    const author = card.querySelector('p').textContent.toLowerCase();
    
    if (title.includes(searchTerm) || author.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
});
</script>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.aspect-w-3 {
  position: relative;
  padding-bottom: 133.333333%;
}

.aspect-h-4 {
  position: absolute;
  height: 100%;
  width: 100%;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
}
</style>
{% endblock %}
