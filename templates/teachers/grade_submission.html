{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto p-4 max-w-2xl">
  <h1 class="text-2xl font-semibold mb-4">Grade Submission</h1>
  <div class="mb-4 p-4 bg-white border rounded">
    <p><strong>Assignment:</strong> {{ assignment.title }}</p>
    <p><strong>Student:</strong> {{ submission.student }}</p>
    {% if submission.file %}
      <p><a href="{{ submission.file.url }}" class="text-indigo-600">Download submission file</a></p>
    {% endif %}
  </div>
  <form method="post" class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div>
      {{ form.marks_obtained.label_tag }}
      {{ form.marks_obtained }}
      {{ form.marks_obtained.errors }}
    </div>
    <div>
      {{ form.feedback.label_tag }}
      {{ form.feedback }}
      {{ form.feedback.errors }}
    </div>
    <div>
      <button class="btn btn-primary">Save Grade</button>
      <a href="{% url 'teachers:assignment_submissions' assignment.id %}" class="btn">Back</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// AJAX submit for grading (enhances UX)
const gradeForm = document.querySelector('form');
if (gradeForm) {
  gradeForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const url = "{% url 'teachers:grade_submission_ajax' assignment.id submission.id %}";
    const formData = new FormData(gradeForm);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        alert('Graded: ' + data.marks_obtained);
        window.location = "{% url 'teachers:assignment_submissions' assignment.id %}";
      } else {
        alert('Error: ' + (data.error || JSON.stringify(data.errors)));
      }
    } catch (err) {
      alert('Network error');
    }
  });
}
</script>
{% endblock %}
